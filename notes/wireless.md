# Wireless
1. [基礎知識](#anchor1)
   - 電波と電磁波
   - 周波数 ( Hz )
   - 電波干渉 ( Interference )
   - 電波の種類
   - 電波の大きさ ( dB )
   - スペクトラムアナライザ
2. [変調方式](#anchor2)
   - AM ( Amplitude Modulation ：振幅変調 ) 方式
   - FM ( Frequency Modulation ：周波数変調 ) 方式
   - PM ( Phase Modulation ：位相変調 ) 方式
   - ２次変調
3. [無線技術](#anchor3)
   - MIMO ( Multi Input Multi Output )
   - ビームフォーミング
   - IEEE 802.11ac
   - CSMA / CA ( Carrier Sence Multiple Access with Collision Avoidance )
   - RTS / CTS 方式
   - IFS ( Inter Frame Space )
4. [無線 LAN 接続の順序](#anchor4)
5. [無線 LAN セキュリティ](#anchor5)
   - ANY 接続禁止機能 ( ステルス SSID )
   - MAC アドレスフィルタリング
   - WEP ( Wired Equivalent Privacy )
   - TKIP ( Temporal Key Integrity Protocol )
   - CCMP ( Counter mode with Cbc-Mac Protocol )
6. [WPA ( Wi-Fi Protected Access )](#anchor6)
   - WPA1 / WPA2
   - セキュリティ規格の比較
   - ４ウェイハンドシェイク
   - ２ウェイハンドシェイク
7. [IEEE802.1x](#anchor7)
   - 認証までの順序
   - 認証方式


<a id="anchor1"></a>

## 1. 基礎知識

### 電波と電磁波
 - 電波は電磁波とも呼ばれ、電気と磁力の性質を持ち合わせます。<br>そのため、電気をよく通す金属は **電波の反射** が発生します。<br>また、電気を通さない木などは **電波が通過** します。<br>このように、電波は物質に対して反射または通過 ( 屈折 ) するという性質があります。
 - **フレミングの左手の法則** により、電流 ( 電界) と磁場 ( 磁界 ) は直角に交わります。
    - 中指：I ( 電流 )
    - 人差し指 ：B ( 磁場 )
    - 親指：F ( 力の向き )
 - **アンペールの右ねじの法則** により、親指の指す方向に電流の向きがあります。

#### 無線の仕組み
1. アンテナに電流を流すと、右ねじの法則により磁界 ( N , S の磁場 ) が発生
2. 磁界が発生すると、フレミングの左手の法則により、磁界と垂直に電界が発生
3. 発生した電界により磁場が発生
4. これを光の速さで繰り返すことでリング状の電界と磁界が発生 ( これが電波 )
   - 電波の速度はおよそ **１秒間で３０万 km** , 時速１０億８０００万 km ( 地球７周半 )

### 周波数 ( Hz )
 - １秒間に繰り返す波の数です。

    ```:公式
    周波数 = 電波の速度 / 波長 ( 波長 = 電波の速度 / 周波数 )
    ```

 - **波長** とは、山の頂上から次の山の頂上までに１つの波が進む距離です。
 - 周波数は単一ではなく、伝送する内容によって開きがあり、それが **周波数帯域** と言います。<br>電波の周波数を表す際は、周波数帯域の真ん中を使用した **中心周波数** で表します。
 - 周波数が高い電波は **直進性** が強く、音のように周波数が低い電波は **回り込む** 性質が強くなります。

### 電波干渉 ( Interference )
 - 周波数が近い２つ以上の電波が付近にあると、**お互いを強めたり弱めたりする現象** です。
 - 同じ周波数の電波を受信して、それらの電波を区別できない現象を **電波の混信** と呼びます。
 - 目的の周波数 ( x ) と付近の周波数 ( y ) とし、整数 m , n で以下の周波数にノイズが発生します。

    ```:公式
    mx ± ny
    ```
 - 同一チャンネルでは、別の SSID と **20dB ( 100倍 ) 以上** の差があれば、干渉問題は気にしなくても大丈夫です。

### 電波の種類
 - 3THz 以下のものは **電磁波** です。
 - 3THz 以上のものは **光** です。
 - 400THz ~ 800THz のものは **可視光線** です。
 - 10000THz 以上のものは **放射線** です。

|名称|周波数|波長|特徴|
|---|---|---|---|
|中波<br>Medium Frequency|300kHz ~ 3MHz|1km ~ 100m|AM ラジオ|
|短波<br>High Frequency|3MHz ~ 30MHz|100m ~ 10m|アマチュア無線|
|超短波<br>Very High Frequency|30MHz ~ 300MHz|10m ~ 1m|アナログテレビ放送|
|極超短波<br>Ultra High Frequency|300MHz ~ 3GHz|1m ~ 10cm|無線 LAN 2.4GHz 帯<br>地表での反射で衰退<br>水分子を効率よく吸収 ( 電子レンジ )|
|マイクロ波<br>Super High Frequency|3GHz ~ 30GHz|10cm ~ 1cm|無線 LAN 5GHz 帯<br>波長が短く直進性が高い<br>衛星放送, レーダー|
|ミリ波<br>Extremely High Frequency|30GHz ~ 300GHz|1cm ~ 1mm|１秒間の波が非常に多いため、多くの情報を送信<br>空港などの全身スキャナー|

### 電波の大きさ ( dB )
 - 送信装置からアンテナに供給される電力を **空中線電力** と呼び、**電流と電圧を乗じた電力 ( W )** で表します。
 - 無線 LAN の電力は電波法で制限され、1MHz あたり 1.25mW ~ 10mW で送信することが定められています。
 - 電波の強さは、基準をあらかじめ定め、その基準に対して大小を対数 ( log ) で表す ( ベル B ) を単位とします。<br>この値を１０倍した **デシベル ( dB )** という単位で表すのが普通です。
    - 電波の場合は、基準が **1mW** なので **dBm** となります。

    ```:公式
    電波の強さ ( dBm ) = 10 * log10 { 対象の電波の強さ ( mW ) / 基準 1 ( mW ) }
    ```

### スペクトラムアナライザ
 - 電波の強さを測定して **電波の見える化** を行う装置です。
 - 横軸に **周波数 ( Hz )** と縦軸に **電力 ( dB )** が表示され、電波の形を周波数で分解して表示します。
 - その瞬間における周波数ごとの利用状況や外来派のノイズを確認することができます。

<a id="anchor2"></a>

## 2. 変調方式

### AM ( Amplitude Modulation ：振幅変調 ) 方式
 - データを送るための特定の周波数 ( 以後 **搬送波** ) に音声信号を足し合わせて電波の振幅を変化させる方式です。
 - AM ラジオやアナログテレビで使用されています。
 - 搬送波の大きな山の両側に **側帯波** と呼ばれる同じサイズの小さな波が表示されます。

### FM ( Frequency Modulation ：周波数変調 ) 方式
 - 搬送波の周波数を音声の周波数に合わせて変化させる方式です。
 - AM 方式よりも広い側帯波が表示されます。

### PM ( Phase Modulation ：位相変調 ) 方式
 - 送信するデータに応じて搬送波の ` 角度 ( θ ：シータ ) = 位相 ( θ ：シータ ) ` をずらす方式です。
 - 位相 ( Phase ) の変化を変調に用いるため **位相偏移変調 ( PSK ：Phase Shift Keying )** とも呼ばれます。
 - デジタル信号を送信するのに適した変調方式です。

#### シータ ( θ )
 - 搬送波は円弧を描いた周期的な形となるため、180 度 を π ( パイ ) としたラジアンで表記します。
 - 周波数の波は θ ( π ) が 0 から 2 まで変化する間に波が進む距離を波長と言います。

### ２次変調
 - 無線 LAN でデータを送信する場合は以下の変調処理を行います。
1. コンピュータが扱う 0 と 1 のデータをキャリア ( 搬送波 ) に乗せて通信するための **変調波** に変えます。
    - 01 データを送信すると、多くの場合ノイズや符号誤りが発生してしまうためです。
    - この処理は **デジタル変調** と呼ばれ、**１次変調** とも呼ばれています。
2. デジタル変調された信号 ( 変調信号 ) を複数の周波数で利用するためにマルチキャリア伝送処理を行います。
    - この処理を **２次変調** と呼びます。
    - スペクトラム拡散 ( Spread Spectrum ) などいくつかの方法で処理を行います。
 - デジタル符号化とマルチキャリア伝送方式の組み合わせを **MCS ( Modulation and Coding Scheme )** と呼びます。

|２次変調|概要|スペクトラム形状|用途|
|---|---|---|---|
|FHSS<br>( Frequency Hopping Spread Spectrum)|短い単位で異なる周波数に切り替えて通信|切り替える周波数を覆う長方形|Bluetooth|
|DSSS<br>( Direct Sequence Spread Spectrum )|拡散符号を用いて変調波を乗算し、<br>広い周波数に信号を拡散|中心周波数を中央とした椀型|IEEE 802.11b<br>ビデオカメラ|
|OFDM<br>( Orthogonal Frequency Division Multiplexing )|変調波を４８個のサブキャリアに分解して、<br>異なる周波数で送受信|中心周波数を中央とした長方形|IEEE 802.11a<br>IEEE 802.11g<br>IEEE 802.11n<br>ADSL<br>地デジ|

<a id="anchor3"></a>

## 3. 無線技術

### MIMO ( Multi Input Multi Output )
 - 複数のアンテナおよびチャネルを使用して、かつ同一チャネルで同時通信を行う技術です。
 - 拡張した MU - MIMO ( Multi User Multi Input Multi Output ) では、アクセスポイントが複数の端末と<br>異なるチャンネルで同時に通信することができます。

### ビームフォーミング
 - 端末からの応答パケットの信号強度などに応じて、同一チャネルの信号を水平方向や垂直方向にずらして送信する仕組みです。
 - 電波の届きにくい場所に設置されている端末でも安定して通信を行うことができます。

### IEEE 802.11ac
 - 5GHz 帯を使用します。
 - 20, 40, 60, 80, 160MHz の帯域を使用して、最大 20MHZ × 8CH の MIMO が可能です。
 - 基準の 20MHz チャネルをプライマリチャネルとし、通信チャネルを増減することで帯域幅の拡大や縮小ができます。
 - ガードインターバルを 800ns から 400ns に短縮することが可能です。

### CSMA / CA ( Carrier Sence Multiple Access with Collision Avoidance ：搬送波感知多重アクセス / 衝突回避 )
 - 端末が通信する際に、衝突を避けながら任意にアクセスする仕組みです。**MAC ( Media Access Control )** とも呼びます。
 - 無線 LAN での CSMA /CA の **帯域利用率は 30 ％ 程度** になってしまいます。
1. 他の端末が該当チャンネルに信号を出していないことを **( Carrier Sence ：搬送波検知 )** で確認します。
    - 他の端末が送信するプリアンブルを検出することで、他の通信を感知します。
    - 他の通信の制御・管理パケットを受信して、信号の大きさ ( dB ) の閾値によって信号が流れているか判断します。
2. 信号が流れていない場合、その時点で選択可能な符号化や伝送処理 ( MCS ) を選択して送信します。
3. データパケットを受信したアクセスポイントは、正しく受信したことを示す ( ACK ：確認応答 ) を送信元に即座に返します。
    - 送信側に設定した時間内に ACK を受信できない場合は、一定時間後に再度パケットを送信します。<br>**( DCF ：Distributed Coordination Function )**
    - ACK の送信元アドレスを空欄にすることで、少しでも早く ACK を返すような機器も存在します。
 - インフラストラクチャーモードでは **PCF ( Point Coordination Function )** も使用することができます。
    - アクセスポイントがポーリングを行って各端末の通信を集中的に制御する仕組みです。

### RTS / CTS 方式
 - 無線 LAN 送信制御技術の１つです。CSMA /CA よりオーバーヘッドが大きくなるため、原則使用はされません。
 - RTS ( Request To Send ：送信要求 ) とは、端末がアクセスポイントに対して送信要求を求めるパケットです。
 - CTS ( Clear To Send ：送信可能 ) とは、端末がデータ送信可能であることを伝えるパケットです。
1. 端末はアクセスポイントに対して RTS を送信します。
2. アクセスポイントが RTS を受信すると、他の通信の終了を待ちます。
3. 通信が可能になったら CTS を端末に送信します。

### IFS ( Inter Frame Space )
 - パケットを送信する前に空ける時間です。優先度に応じて４種類存在します。<br>IFS が短ければ早くパケットを送信することができます。
1. SIFS ( Short IFS )
    - ACK パケットなどで使用されます。
2. PIFS ( PCF IFS )
    - ポーリングの制御に使用されます。
3. DIFS ( DCF IFS )
    - データパケットなどで使用されます。
4. EIFS ( Extended IFS )
    - 輻輳を防ぐために拡張された IFS です。
    - ` EIFS = SIFS + ACK パケットの送信時間 + DIFS ` で算出されます。

<a id="anchor4"></a>

## 4. 無線 LAN 接続の順序

|順序|パケットの種類|方向|説明|
|---|---|---|---|
|1|ビーコン|アクセスポイント<br>→ブロードキャスト|アクセスポイントが SSID や通信方式などを通知|
|2|プローブ要求|端末<br>→アクセスポイント|端末が全てのアクセスポイント宛に通信規格や速度を指定して調査|
|3|プローブ応答|アクセスポイント<br>→端末|プローブ要求に該当したアクセスポイントが端末の調査に対して、<br>通信速度や対応規格などを通知|
|4|認証|端末<br>→アクセスポイント|端末がアクセスポイントに対して、オープンシステム認証と SSID の確認を実施|
|5|認証|アクセスポイント<br>→端末|アクセスポイントが端末に対して、オープンシステム認証と SSID の確認を実施|
|6|アソシエーション要求|端末<br>→アクセスポイント|端末からアクセスポイントに対して、データリンク確立のアソシエーションを要求|
|7|アソシエーション応答|アクセスポイント<br>→端末|アクセスポイントが端末に対して、アソシエーション許可を応答<br>ここでデータリンクが確立|
|8|データパケット|端末<br>→ブロードキャスト ( DHCP )|アソシエーションで確立したデータリンクで通信|

<a id="anchor5"></a>

## 5. 無線 LAN セキュリティ

### ANY 接続禁止機能 ( ステルス SSID )
 - 無線 LAN 端末がプローブ要求を送信する際に **SSID を空欄** にすると、エリア内のアクセスポイント一覧を取得できます。<br>**ANY 接続機能**
 - アクセスポイントがプローブ要求の SSID を確認し、 **any または空欄** のプローブ要求には応じないようにします。<br>これが **ANY 接続禁止機能 ( ステルス SSID )** です。
 - しかし、キャプチャ ( 盗聴 ) 等で、端末やアクセスポイントから流れる管理パケットなどで SSID は知られてしまします。

### MAC アドレスフィルタリング
 - 接続を許可する端末の MAC アドレスをアクセスポイントに登録し、登録した端末のみ通信を許可する方法です。
 - アクセスポイントに接続する端末が少ない場合や、アクセスポイントが１つのみの場合に有効です。
 - しかし、**MAC アドレスは比較的簡単に偽造することができます。**<br>また、WPA2 の TKIP / AES などでも MAC アドレスは暗号化されません。

### WEP ( Wired Equivalent Privacy )
 - パケットのデータ部分とチェックサムを暗号化・複合化して機密性を確保する無線 LAN セキュリティ技術です。
1. パケット送信時に毎回 **IV ( Initialization Vector ：初期化ベクトル )** という 24 bit のデータを作成
2. IV と WEP キー ( 固定鍵 ) を組み合させて RC4 関数に代入し、一意のキーストリーム ( ハッシュ値 ) を作成
3. 平文のメッセージとキーストリームの排他的論理和 ( XOR ) を暗号文として使用
4. IV と暗号化と同一の WEP キーの排他的論理和演算を使用して平文に複合化
 - 総当たり攻撃に弱い
 - Cain And Abel などの攻撃ツールが存在

### TKIP ( Temporal Key Integrity Protocol )
 - WEP の脆弱性を克服しようとした無線 LAN のセキュリティ技術です。
 - MIC ( Message Integrity Code ) と呼ばれるハッシュとして利用するコードで完全性を提供します。
1. 無線 LAN 通信時にアクセスポイントと端末で MIC を生成
   - 送信用 MIC と受信用 MIC がそれぞれ存在します。
2. パケット送信時に MAC アドレス, データ, MIC を混ぜ合わせてハッシュ値を生成
3. ハッシュ値を MIC フィールドに添付することで改ざんを防止

### CCMP ( Counter mode with Cbc-Mac Protocol )
 - 暗号化に AES ( Advanced Encryption Standard ) を使用する、RFC3610 で標準化された無線 LAN の暗号・認証技術です。
 - CBC モード ( Cipher Block Chaining Mode ：暗号ブロック連鎖モード ) を利用します。
    - 平文に、直前の平文ブロックを AES 暗号化した結果を XOR 演算で重ね合わせ、その結果に対して暗号化処理を実施
 - 暗号文のハッシュとして AES-MAC ( Message Authentication Code ) を作成して、リプライ攻撃を防ぎます。

<a id="anchor6"></a>

## 6. WPA ( Wi-Fi Protected Access )
 - Wi-Fi アライアンスという団体が策定した無線 LAN セキュリティ標準です。
 - 認証は以下のプロトコルを利用します。
1. **EAP ( Extensible Authentication Protocol )**
    - IEEE802.1x で用いられるデータリンク層の認証プロトコルです。
    - 上位の Authentication 層 の TLS 等の接続や認証処理を規定します。
2. **EAPOL ( Extensible Authentication Protocol over LAN )**
    - EAP とデータリンク層プロトコルとの接続を行うプロトコルです。

### WPA1 / WPA2
 - WPA1 は WEP で動作する機器のアップデートを念頭に置いた標準です。
    - 暗号化方式は TKIP
    - 認証方式は IEEE802.1x ( 認証サーバーを用いた WPA-Enterprise と 事前共有鍵を用いた WPA-HOME )
 - WPA2 は AES を暗号化アルゴリズムに用いた CCMP を暗号化に利用した標準です。
    - 認証方式は IEEE802.1x ( 認証サーバーを用いた WPA2-Enterprise と 事前共有鍵を用いた WPA2-HOME )

   |方式|WPA-HOME<br>( PSK )|WPA-Enterprise<br>( IEEE802.1x )|WPA2-HOME<br>( PSK )|WPA2-Enterprise<br>( IEEE802.1x )|
   |---|---|---|---|---|
   |用途|家庭|企業|家庭|企業|
   |認証|PSK ( 事前共有鍵 )|IEEE802.1x|PSK ( 事前共有鍵 )|IEEE802.1x|
   |暗号化|TKIP|TKIP|CCMP|CCMP|

### セキュリティ規格の比較

|仕様|WEP|TKIP ( WPA1)|CCMP ( WPA2 )|
|---|---|---|---|
|暗号化アルゴリズム|RC4|RC4|AES|
|暗号化鍵長 ( bit )|40 + 24 ( IV ) / 104 + 24 ( IV )|104|128|
|認証アルゴリズム|CRC32 ( チェックサム )|MIC ( パケットのハッシュ )|CCM ( Counter with CBC-MAC )|
|認証鍵長 ( bit )|-|64|64|
|IV ( bit )|24|48|48|

### ４ウェイハンドシェイク
 - WPA において、プローブ要求からアソシエーション応答の後で、アクセスポイントと端末との間で行われる処理です。
 - 接続の都度１回行われます。
 - 認証処理と PTK ( Pairwise Transient Key ) の交換を行います。
 - アクセスポイントと複数の端末でブロードキャストとマルチキャストのための GTK ( Group Transient Key ) もアクセスポイントから配布します。

#### PSK 方式
1. アクセスポイントは、暗号化や認証のプロトコルや方式を ANonce ( オーセンティケーター擬似乱数 ) とともに端末に送信
2. 端末は、アクセスポイントから送られた認証方式などを確認し、MIC と SNonce ( サプリカント擬似乱数 ) をアクセスポイントに送信<br>また、PTK を作成
3. アクセスポイントは、端末から受け取った SNonce と MIC から PTK を作成<br>また、GTK と MIC を端末に送信
4. 端末は、アクセスポイントから送られた MIC を確認して ACK をアクセスポイントに送信

### ２ウェイハンドシェイク
 - GTK は複数の端末で共有されるためセキュリティレベルが下がります。
 - アクセスポイントで更新間隔を設定して GTK を定期的に更新するための処理です。

<a id="anchor7"></a>

## 7. IEEE802.1x
 - 有線と無線で利用できるデータリンク層の認証プロトコルです。
 - **サプリカント** ：認証要求をおこなうクライアント端末です。
 - **オーセンティケーター** ：IEEE802.1x 対応の SW や AP などの機器です。認証結果によってアクセス制御を行います。
 - **認証サーバー** ：認証結果をオーセンティケーターに通知するサーバーです。

### 認証までの順序
1. 認証対象の無線 LAN 端末 ( サプリカント ) に認証ソフトウェアをインストール
2. 無線 LAN アクセスポイント ( オーセンティケーター ) に認証サーバー ( RADIUS ) の IP アドレスやシークレットを登録
3. 認証サーバーにシークレットを登録<br>サプリカントに証明書を発行
4. サプリカントとオーセンティケーターがリンクを確立して EAP 層の通信を準備
5. オーセンティケーターがサプリカントに認証要求を送信
6. サプリカントがオーセンティケーターに認証情報を送信
7. オーセンティケーターが認証サーバーに認証情報を送信
8. 認証サーバーがオーセンティケーターに認証結果と、サプリカントに暗号化に使用する鍵の元 ( PMK ) を送信
9. 暗号化通信の開始

### 認証方式

|種類|説明|
|---|---|
|MD5 チャレンジレスポンス方式|MD5 アルゴリズムを使用したチャレンジレスポンス型の認証方式<br>今日ではセキュリティが低いと評価|
|TLS ( EAP-TLS ) 方式<br>( SSL / TLS )|PKI による相互認証を行う認証方式<br>オーセンティケーターとサプリカントに証明書のインストールが必要|
|EAP-TTLS 方式<br>( EAP Tunneled TLS )|TLS を改良して、管理を容易にした方式<br>ユーザー名とパスワードで認証を実現|
|PEAP 方式|サプリカント側がパスワード認証を行い、証明書を認証サーバーにのみインストールする認証方式|
|LEAP 方式|Cisco 社独自仕様の認証方式<br>端末に別途専用のサプリカントのインストールが必要|
