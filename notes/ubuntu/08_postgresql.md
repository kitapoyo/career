# PostgreSQL
1. [インストール](#anchor1)
2. [クライアントコマンド](#anchor2)
   - 管理者でログインする場合
   - ユーザー作成
3. [バックアップ](#anchor3)
   - ユーザー hoge が sampledb を sampledb.txt ファイルにバックアップする場合
   - ユーザー hoge が sampledb を sampledb.tar ファイルにバックアップする場合
4. [リストア](#anchor4)

<a id="anchor1"></a>

## 1. インストール
 - 管理者ユーザーとして **postgres** ユーザーが作成されます。

    ```:コマンド
    sudo apt -y install postgresql
    ```

 - 確認

    ```:コマンド
    sudo netstat -tap | grep postgres
    ```

    ```:表示例
    tcp        0      0 localhost:postgresql    0.0.0.0:*          LISTEN      9385/postgres
    ```

<a id="anchor2"></a>

## 2. クライアントコマンド
 - 書式

    ```:コマンド
    psql [ オプション ] < データーベース名 >
    ```

    |オプション|説明|
    |---|---|
    |-l|データーベースの一覧を表示します。|
    |-d < データーベース >|指定したデーターベースに接続します。|
    |-u < ユーザー名 >|接続するユーザー名を指定します。 デフォルトはコマンドを実行したユーザーです。|
    |-h < ホスト名 >|接続先ホストを指定します。デフォルトは localhost です。|

    |サブコマンド|説明|
    |----|----|
    |\c データベース|指定したデータベースに接続する|
    |\du|ロールを一覧表示する|
    |\dt|テーブルを一覧表示する|
    |\dS|システムテーブル一覧を表示する|
    |\dv|ビューを一覧表示する|
    |\l|データベース一覧を表示する|
    |\z|権限を一覧表示する|
    |\q|psql を終了する|

 - データーベース一覧

    ```:コマンド
    \l
    ```

 - sys データーベースに接続する場合

    ```:コマンド
    \c sys;
    ```

 - 接続中のデーターベース内にあるテーブルを表示

    ```:コマンド
    \dt
    ```

 - システムテーブルの表示

    ```:コマンド
    \dS
    ```

 - ユーザー一覧

    ```:コマンド
    select * from pg_user;
    ```

### 管理者でログインする場合
1. 管理者ユーザーに切り替えます。

    ```:コマンド
    sudo su - postgres
    ```

2. データーベースにアクセスします。

    ```:コマンド
    psql -d postgres
    ```



### ユーザー作成
 - postgres ユーザーで実行するコマンド

    ```:コマンド
    createuser --interactive
    ```
 - psql モードで実行するコマンド

    ```:コマンド
    create user hoge;
    \password hoge
    ```

<a id="anchor3"></a>

## 3. バックアップ
 - ` pg_dump ` コマンドでデーターベースをバックアップします。

    ```:コマンド
    pg_dump [ オプション ] < データーベース名 >
    ```

    |オプション|説明|
    |---|---|
    |-h < ホスト名 >|接続先ホストを指定します。|
    |-U < ユーザー名 >|接続するユーザーを指定します。|
    |-p < ポート番号 >|ポート番号を指定します。デフォルトは５４３２番です。|
    |-d < データーベース名 >|接続するデーターベース名を指定します。|
    |-a|データのみダンプし、スキームは出力しません。|
    |-b|ラージオブジェクトもダンプします。|
    |-f < ファイル >|指定したファイルにダンプします。|
    |-s|データは含めず、スキームのみダンプします。|
    |-F < フォーマット >|アーカイブのフォーマットを指定します。<br>**c** ：カスタム<br>**d** ：ディレクトリ<br>**t** ：tar アーカイブ|

### ユーザー hoge が sampledb を sampledb.txt ファイルにバックアップする場合

 ```:コマンド
 pg_dump -U hoge sampledb -f sampledb.txt
 ```

### ユーザー hoge が sampledb を sampledb.tar ファイルにバックアップする場合

 ```:コマンド
 pg_dump -U hoge -Ft sampledb -f sampledb.tar
 ```

<a id="anchor4"></a>

## 4. リストア
 - ` psql ` コマンドもしくは ` pg_restore ` コマンドを使用します。

    ```:コマンド
    psql -U hoge sampledb < sampledb.txt
    ```

    ```:コマンド
    pg_restore [ オプション ] < ファイル名 >
    ```

    |オプション|説明|
    |---|---|
    |-a|データのみリストアし、スキームはリストアしません。|
    |-U < ユーザー名 >|接続するユーザーを指定します。|
    |-p < ポート番号 >|ポート番号を指定します。デフォルトは５４３２番です。|
    |-d < データーベース名 >|接続し、リストアするデーターベース名を指定します。|
    |-C|リストア前にデータベースを作成します。|
    |-l|アーカイブ内をリスト表示します。|
    |-F < フォーマット >|アーカイブのフォーマットを指定します。<br>**c** ：カスタム<br>**d** ：ディレクトリ<br>**t** ：tar アーカイブ|

 - sampledb データベースを sampledb.tar からリストアする場合

     ```:コマンド
     pg_restore -U hoge -d sampledb -C -Ft sample.tar
     ```
