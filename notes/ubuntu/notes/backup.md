# Baukup & Restore
1. [バックアップの種類](#anchor1)
2. [バックアップコマンド ( dump )](#anchor2)
3. [リストアコマンド ( restore )](#anchor3)
4. [rsync コマンド](#anchor4)
5. [バックアップサーバーの構築](#anchor5)

<a id="anchor1"></a>

## 1. バックアップの種類

### 完全バックアップ
 - すべてのファイルを対象としたバックアップです。

### 差分バックアップ
 - 前回の完全バックアップ以降に作成・変更されたファイルのみのバックアップです。

### 増分バックアップ
 - 前回のバックアップ ( 完全・差分・増分 ) 以降に作成・変更されたファイルのみのバックアップです。

<a id="anchor2"></a>

## 2. バックアップコマンド ( dump )
 - dump レベルを指定することで、差分・増分バックアップができます。
 - dump コマンドのオプションは **-** が必要ありません。

### インストール

 ```:コマンド
 sudo apt -y install dump
 ```

### コマンド書式

 ```:コマンド書式
 dump [ オプション ] < バックアップ対象 >
 ```

### オプション

|オプション|説明|
|---|---|
|0 ~ 9|dump レベルを指定します。０は完全バックアップです。|
|u|バックアップ実施時に、**/var/lib/dumpdates ファイル** を更新します。増分バックアップに必要です。|
|f < ファイル名 >|バックアップを保存するファイル名を指定します。|

<a id="anchor3"></a>

## 3. リストアコマンド ( restore )
 - dump コマンドで行ったバックアップは、**restore** コマンドで復元します。

### コマンド書式

 ```:書式
 restore [ オプション ] < バックアップファイル名 >
 ```

<a id="anchor4"></a>

## 4. rsync コマンド
 - ２つのディレクトリ間でファイルをコピーします。ディレクトリの同期を取るのに便利です。
 - ネットワークを経由したリモートコピーも可能です。

### コマンド書式

 ```:コマンド書式
 rsync [ オプション ] <コピー元ディレクトリ > < コピー先ディレクトリ >
 ```

### オプション

|オプション|説明|
|---|---|
|-v|コピー中のファイルを表示します。|
|-a|アーカイブモード ( ファイルやディレクトリんも属性をそのままコピー ) で実行します。|
|-r|ディレクトリ内を再帰的にコピーします。|
|-u|変更・追加されたファイルのみコピーします。|
|-l|シンボリックリンクをそのままコピーします。|
|-H|ハードリンクをそのままコピーします。|
|-p|パーティションをそのままコピーします。|
|-o|所有者をそのままコピーします。|
|-g|所有グループをそのままコピーします。|
|-t|タイムスタンプをそのままコピーします。|
|-e ssh|SSH を使用して転送します。|
|-z|通信データを圧縮します。|
|--delete|コピー元ファイルが削除されていれば、コピー先でも削除します。|

### バックアップ例
 - ホームディレクトリを **/backup** にコピーする場合<br>` sudo rsync -auv --delete ~ backup `
 - ホームディレクトリ以下を **/backup** にコピーする場合<br>` sudo rsync -auv --delete ~/ backup `
 - SSH でホームディレクトリをホスト **example.com** の **/backup** にコピーする場合<br>` rsync -auv --delete -e ssh ~ example.com:/backup `

<a id="anchor5"></a>

## 5. バックアップサーバーの構築
 - バックアップを受け取る側で、rsync サービスを提供します。
1. **/etc/default/rsync** ファイルを編集します。

    ```コマンド
    sudo vim /etc/default/rsync
    ```

2. １４行目 **RSYNC_ENABLE** を **true** に変更します。
3. rsync の設定ファイルとして **/etc/rsyncd.conf** を作成します。

    ```:コマンド
    sudo vim /etc/rsyncd.conf
    ```

4. 以下の内容を追記します。

    ```:追記例
    [backup-hoge] # 任意の名前
    path = /backup # バックアップを保存するディレクトリ
    hosts allow = 127.0.0.1 # バックアップ送信側のIPアドレス
    hosts deny = *
    uid = root
    gid = root
    read only = false
    ```

5. rsync サービスを起動します。

    ```:コマンド
    sudo systemctl start rsync
    ```

### バックアップ元ホストで実施するコマンド

 ```:コマンド
 rsync [ オプション ] < バックアップ元ディレクトリ > < 送信先ホスト名::設定名 >
 ```
- ホームディレクトリを **example.com:/backup** にコピーする場合<br>` rsync -avz --delete ~ example.com::backup-hoge `
